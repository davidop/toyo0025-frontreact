# ğŸš€ Pipeline Simple para Desarrolladores Junior
# Solo 2 etapas: Build â†’ Deploy

stages:
  - build
  - deploy

variables:
  NODE_VERSION: '18'

# ğŸ”¨ ETAPA 1: Construir la aplicaciÃ³n
build:
  stage: build
  image: node:$NODE_VERSION
  only:
    - main
    - develop
    - master
  script:
    - echo "ğŸ“¦ Instalando dependencias..."
    - npm ci --cache .npm --prefer-offline --silent
    - echo "ğŸ”¨ Construyendo aplicaciÃ³n React..."
    - npm run build --silent
    - echo "ğŸ“ Preparando archivos para Azure..."
    - cp server.js dist/
    - cp package.json dist/
    - cp web.config dist/
    - echo "ğŸ“¦ Instalando dependencias de producciÃ³n..."
    - cd dist && npm ci --only=production --silent && cd ..
    - echo "âœ… Build completado exitosamente!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  cache:
    paths:
      - .npm/
      - node_modules/

# ğŸš€ ETAPA 2: Desplegar a Azure (AUTOMÃTICO)
deploy:
  stage: deploy
  image: ubuntu:20.04
  only:
    - main
    - develop
    - master
  when: on_success # ï¿½ Deploy automÃ¡tico cuando el build sea exitoso
  dependencies:
    - build
  before_script:
    - echo "ğŸŒ Preparando despliegue a Azure..."
    - apt-get update -qq && apt-get install -y -qq curl zip grep sed > /dev/null 2>&1
  script:
    - echo "ğŸ“¦ Empaquetando aplicaciÃ³n..."
    - cd dist
    - zip -r ../deploy.zip . -x "*.git*" "node_modules/.cache/*" -q
    - cd ..
    - echo "ğŸ“¦ Paquete creado:" && ls -lh deploy.zip
    - echo "ğŸš€ Desplegando a Azure App Service..."
    - |
      if [ -z "$AZURE_WEBAPP_PUBLISH_PROFILE" ]; then
        echo "âŒ ERROR: Falta configurar AZURE_WEBAPP_PUBLISH_PROFILE"
        echo "ğŸ“‹ Sigue los pasos en DEPLOYMENT-GUIDE.md"
        exit 1
      fi
    - echo "$AZURE_WEBAPP_PUBLISH_PROFILE" > publishprofile.xml
    - |
      # Extraer datos del publish profile
      SITE_NAME=$(grep -o 'publishUrl="[^"]*"' publishprofile.xml | head -1 | sed 's/publishUrl="//;s/".*//')
      USER_NAME=$(grep -o 'userName="[^"]*"' publishprofile.xml | head -1 | sed 's/userName="//;s/".*//')
      USER_PWD=$(grep -o 'userPWD="[^"]*"' publishprofile.xml | head -1 | sed 's/userPWD="//;s/".*//')

      echo "ğŸŒ Desplegando a: $SITE_NAME"

      # Deploy usando Web Deploy REST API
      echo "ğŸ”„ Iniciando despliegue..."
      if curl -X POST \
        "https://$SITE_NAME/api/zipdeploy" \
        -u "$USER_NAME:$USER_PWD" \
        -H "Content-Type: application/zip" \
        -T deploy.zip \
        --fail \
        --silent \
        --show-error; then
        echo "âœ… Despliegue exitoso"
      else
        echo "âŒ Error en el despliegue"
        exit 1
      fi
    - echo "ğŸ‰ Â¡Despliegue completado!"
    - echo "ğŸŒ Tu aplicaciÃ³n estÃ¡ disponible en:"
    - echo "   https://dev-tae-eu-w-tes-cms-win.azurewebsites.net"
  after_script:
    - rm -f publishprofile.xml deploy.zip 2>/dev/null || true
    - echo "ğŸ§¹ Archivos temporales eliminados"
# ğŸ“‹ InformaciÃ³n para desarrolladores junior:
#
# 1. Este pipeline se ejecuta automÃ¡ticamente en las ramas: main, develop, master
# 2. El BUILD es automÃ¡tico - instala dependencias y construye React
# 3. El DEPLOY es AUTOMÃTICO - se ejecuta inmediatamente despuÃ©s del build exitoso
# 4. Necesitas configurar AZURE_WEBAPP_PUBLISH_PROFILE en Variables de GitLab
# 5. Sigue la guÃ­a en DEPLOYMENT-GUIDE.md si es tu primera vez
#
# âš ï¸  ATENCIÃ“N: Los cambios se despliegan automÃ¡ticamente a producciÃ³n
# Â¿Problemas? Revisa los logs del pipeline o pide ayuda al equipo senior
