# ğŸš€ Pipeline Simple para Desarrolladores Junior
# Solo 2 etapas: Build â†’ Deploy

stages:
  - build
  - deploy

variables:
  NODE_VERSION: '18'

# ğŸ”¨ ETAPA 1: Construir la aplicaciÃ³n
build:
  stage: build
  image: node:$NODE_VERSION
  only:
    - main
    - develop
    - master
  script:
    - echo "ğŸ“¦ Instalando dependencias..."
    - npm ci --cache .npm --prefer-offline --silent
    - echo "ğŸ”¨ Construyendo aplicaciÃ³n React..."
    - npm run build --silent
    - echo "ğŸ“ Preparando archivos para Azure..."
    - cp server.js dist/
    - cp package.json dist/
    - cp web.config dist/
    - echo "ğŸ“¦ Instalando dependencias de producciÃ³n..."
    - cd dist && npm ci --only=production --silent && cd ..
    - echo "âœ… Build completado exitosamente!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  cache:
    paths:
      - .npm/
      - node_modules/

# ğŸš€ ETAPA 2: Desplegar a Azure (AUTOMÃTICO)
deploy:
  stage: deploy
  image: ubuntu:20.04
  only:
    - main
    - develop
    - master
  when: on_success # ï¿½ Deploy automÃ¡tico cuando el build sea exitoso
  dependencies:
    - build
  before_script:
    - echo "ğŸŒ Preparando despliegue a Azure..."
    - apt-get update -qq && apt-get install -y -qq curl zip grep sed > /dev/null 2>&1
  script:
    - echo "ğŸ“¦ Empaquetando aplicaciÃ³n..."
    - cd dist
    - zip -r ../deploy.zip . -x "*.git*" "node_modules/.cache/*" -q
    - cd ..
    - echo "ğŸ“¦ Paquete creado:" && ls -lh deploy.zip
    - echo "ğŸš€ Desplegando a Azure App Service..."
    - |
      if [ -z "$AZURE_WEBAPP_PUBLISH_PROFILE" ]; then
        echo "âŒ ERROR: Falta configurar AZURE_WEBAPP_PUBLISH_PROFILE"
        echo "ğŸ“‹ Sigue los pasos en DEPLOYMENT-GUIDE.md"
        exit 1
      fi
    - echo "$AZURE_WEBAPP_PUBLISH_PROFILE" > publishprofile.xml
    - |
      # Extraer datos del publish profile
      SITE_NAME=$(grep -o 'publishUrl="[^"]*"' publishprofile.xml | head -1 | sed 's/publishUrl="//;s/".*//')
      USER_NAME=$(grep -o 'userName="[^"]*"' publishprofile.xml | head -1 | sed 's/userName="//;s/".*//')
      USER_PWD=$(grep -o 'userPWD="[^"]*"' publishprofile.xml | head -1 | sed 's/userPWD="//;s/".*//')

      # Debug: Verificar que las variables se extrajeron correctamente
      echo "ğŸ” Verificando configuraciÃ³n..."
      echo "ğŸ“ Sitio: $SITE_NAME"
      echo "ğŸ‘¤ Usuario: ${USER_NAME:0:10}..."
      echo "ğŸ”‘ Password: ${USER_PWD:+[SET]}"
      
      # Verificar que el archivo ZIP existe y no estÃ¡ vacÃ­o
      if [ ! -f deploy.zip ]; then
        echo "âŒ ERROR: No se encontrÃ³ deploy.zip"
        exit 1
      fi
      
      if [ ! -s deploy.zip ]; then
        echo "âŒ ERROR: deploy.zip estÃ¡ vacÃ­o"
        exit 1
      fi

      echo "ğŸŒ Desplegando a: $SITE_NAME"
      echo "ğŸ“¦ TamaÃ±o del paquete: $(ls -lh deploy.zip | awk '{print $5}')"

      # Deploy usando Web Deploy REST API con mejor manejo de errores
      echo "ğŸ”„ Iniciando despliegue..."
      
      # FunciÃ³n para intentar el despliegue con reintentos
      MAX_RETRIES=3
      RETRY_COUNT=0
      
      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        # Crear archivo temporal para capturar respuesta
        RESPONSE_FILE=$(mktemp)
        HTTP_CODE=$(curl -X POST \
          "https://$SITE_NAME/api/zipdeploy" \
          -u "$USER_NAME:$USER_PWD" \
          -H "Content-Type: application/zip" \
          -T deploy.zip \
          --write-out "%{http_code}" \
          --output "$RESPONSE_FILE" \
          --silent \
          --show-error \
          --connect-timeout 30 \
          --max-time 300)
        
        echo "ğŸ“Š CÃ³digo de respuesta HTTP: $HTTP_CODE (intento $((RETRY_COUNT + 1))/$MAX_RETRIES)"
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
          echo "âœ… Despliegue exitoso (HTTP $HTTP_CODE)"
          echo "ğŸ“„ Respuesta del servidor:"
          cat "$RESPONSE_FILE" | head -10
          rm -f "$RESPONSE_FILE"
          break
        elif [ "$HTTP_CODE" -eq 409 ]; then
          echo "â³ Conflicto detectado (HTTP 409) - Otro despliegue en curso"
          echo "ğŸ“„ Respuesta del servidor:"
          cat "$RESPONSE_FILE" | head -5
          rm -f "$RESPONSE_FILE"
          
          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            WAIT_TIME=$((30 + RETRY_COUNT * 15))
            echo "âŒ› Esperando ${WAIT_TIME}s antes del siguiente intento..."
            sleep $WAIT_TIME
          fi
        else
          echo "âŒ Error en el despliegue (HTTP $HTTP_CODE)"
          echo "ğŸ“„ Respuesta del servidor:"
          cat "$RESPONSE_FILE" | head -20
          rm -f "$RESPONSE_FILE"
          exit 1
        fi
      done
      
      if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo "âŒ MÃ¡ximo de reintentos alcanzado. El servidor sigue ocupado."
        exit 1
      fi
    - echo "ğŸ‰ Â¡Despliegue completado!"
    - echo "ğŸŒ Tu aplicaciÃ³n estÃ¡ disponible en:"
    - echo "   https://dev-tae-eu-w-tes-cms-win.azurewebsites.net"
  after_script:
    - rm -f publishprofile.xml deploy.zip 2>/dev/null || true
    - echo "ğŸ§¹ Archivos temporales eliminados"
# ğŸ“‹ InformaciÃ³n para desarrolladores junior:
#
# 1. Este pipeline se ejecuta automÃ¡ticamente en las ramas: main, develop, master
# 2. El BUILD es automÃ¡tico - instala dependencias y construye React
# 3. El DEPLOY es AUTOMÃTICO - se ejecuta inmediatamente despuÃ©s del build exitoso
# 4. Necesitas configurar AZURE_WEBAPP_PUBLISH_PROFILE en Variables de GitLab
# 5. Sigue la guÃ­a en DEPLOYMENT-GUIDE.md si es tu primera vez
#
# âš ï¸  ATENCIÃ“N: Los cambios se despliegan automÃ¡ticamente a producciÃ³n
# Â¿Problemas? Revisa los logs del pipeline o pide ayuda al equipo senior
