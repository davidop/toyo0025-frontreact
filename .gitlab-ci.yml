# 🚀 Pipeline Simple para Desarrolladores Junior
# Solo 2 etapas: Build → Deploy

stages:
  - build
  - deploy

variables:
  NODE_VERSION: '18'

# 🔨 ETAPA 1: Construir la aplicación
build:
  stage: build
  image: node:$NODE_VERSION
  only:
    - main
    - develop
    - master
  script:
    - echo "📦 Instalando dependencias..."
    - npm ci --cache .npm --prefer-offline --silent
    - echo "🔨 Construyendo aplicación React..."
    - npm run build --silent
    - echo "📁 Preparando archivos para Azure..."
    - cp server.js dist/
    - cp package.json dist/
    - cp web.config dist/
    - echo "📦 Instalando dependencias de producción..."
    - cd dist && npm ci --only=production --silent && cd ..
    - echo "✅ Build completado exitosamente!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  cache:
    paths:
      - .npm/
      - node_modules/

# 🚀 ETAPA 2: Desplegar a Azure (MANUAL)
deploy:
  stage: deploy
  image: ubuntu:20.04
  only:
    - main
    - develop
    - master
  when: manual # 👆 IMPORTANTE: Deploy manual para evitar accidentes
  dependencies:
    - build
  before_script:
    - echo "🌐 Preparando despliegue a Azure..."
    - apt-get update -qq && apt-get install -y -qq curl zip grep sed > /dev/null 2>&1
  script:
    - echo "📦 Empaquetando aplicación..."
    - cd dist
    - zip -r ../deploy.zip . -x "*.git*" "node_modules/.cache/*" -q
    - cd ..
    - echo "📦 Paquete creado:" && ls -lh deploy.zip
    - echo "🚀 Desplegando a Azure App Service..."
    - |
      if [ -z "$AZURE_WEBAPP_PUBLISH_PROFILE" ]; then
        echo "❌ ERROR: Falta configurar AZURE_WEBAPP_PUBLISH_PROFILE"
        echo "📋 Sigue los pasos en DEPLOYMENT-GUIDE.md"
        exit 1
      fi
    - echo "$AZURE_WEBAPP_PUBLISH_PROFILE" > publishprofile.xml
    - |
      # Extraer datos del publish profile
      SITE_NAME=$(grep -o 'publishUrl="[^"]*"' publishprofile.xml | head -1 | sed 's/publishUrl="//;s/".*//')
      USER_NAME=$(grep -o 'userName="[^"]*"' publishprofile.xml | head -1 | sed 's/userName="//;s/".*//')
      USER_PWD=$(grep -o 'userPWD="[^"]*"' publishprofile.xml | head -1 | sed 's/userPWD="//;s/".*//')

      echo "🌍 Desplegando a: $SITE_NAME"

      # Deploy usando Web Deploy REST API
      curl -X POST \
        "https://$SITE_NAME/api/zipdeploy" \
        -u "$USER_NAME:$USER_PWD" \
        -H "Content-Type: application/zip" \
        -T deploy.zip \
        --fail-with-body
    - echo "🎉 ¡Despliegue completado!"
    - echo "🌐 Tu aplicación está disponible en:"
    - echo "   https://dev-tae-eu-w-tes-cms-win.azurewebsites.net"
  after_script:
    - rm -f publishprofile.xml deploy.zip 2>/dev/null || true
    - echo "🧹 Archivos temporales eliminados"
# 📋 Información para desarrolladores junior:
#
# 1. Este pipeline se ejecuta automáticamente en las ramas: main, develop, master
# 2. El BUILD es automático - instala dependencias y construye React
# 3. El DEPLOY es MANUAL - debes hacer clic en "Deploy" en GitLab
# 4. Necesitas configurar AZURE_WEBAPP_PUBLISH_PROFILE en Variables de GitLab
# 5. Sigue la guía en DEPLOYMENT-GUIDE.md si es tu primera vez
#
# ¿Problemas? Revisa los logs del pipeline o pide ayuda al equipo senior
